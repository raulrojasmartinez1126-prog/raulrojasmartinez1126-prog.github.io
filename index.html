<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evaluaci√≥n Cl√≠nica</title>

<style>
body { margin:0; font-family: Arial,sans-serif; background:#f2f5f9; }
header { background:#0d6efd; color:white; padding:15px; text-align:center; font-size:18px; }
.container { padding:15px; }
.card { background:white; border-radius:12px; padding:15px; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,0.08);}
h3 { margin-top:0; color:#0d6efd; }

input[type="text"], input[type="number"], select, input[type="date"] {
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-top:5px;
}

button {
  width:100%;
  padding:12px;
  background:#0d6efd;
  color:white;
  border:none;
  border-radius:10px;
  font-size:16px;
  margin-top:15px;
}

.sintomas-grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:10px;
  margin-top:15px;
}

.sintoma-card {
  border:1.5px solid #d0d7de;
  border-radius:10px;
  padding:10px;
  background:#fff;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
  transition:0.2s;
}

.sintoma-card:hover {
  background:#f0f6ff;
  border-color:#0d6efd;
}

.sintoma-card input { display:none; }

.sintoma-card.seleccionado {
  background:#e7f1ff;
  border-color:#0d6efd;
  font-weight:600;
}

.sintoma-card.seleccionado input {
  display:inline-block;
  transform:scale(1.2);
}

.lista-resultados {
  width:100%;
  background:white;
  border:1px solid #ccc;
  border-radius:8px;
  margin-top:5px;
  max-height:220px;
  overflow-y:auto;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
}

.item-resultado {
  padding:8px;
  cursor:pointer;
  border-bottom:1px solid #eee;
}

.item-resultado:hover {
  background:#f0f6ff;
}
</style>
</head>

<body>

<header>Evaluaci√≥n Cl√≠nica Respiratoria</header>

<div class="container">

  <!-- üîπ DATOS DEL PACIENTE AGRUPADOS -->
  <div class="card">
    <h3>Datos del paciente</h3>
    
    <!-- Fila 1: Nombre, Fecha Nac, Sexo -->
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <input type="text" placeholder="Nombre completo" id="nombrePaciente" style="flex:2;">
      <input type="date" id="fechaNacimiento" style="flex:1;">
      <select id="sexoPaciente" style="flex:1;">
        <option value="">Sexo</option>
        <option>Masculino</option>
        <option>Femenino</option>
        <option>Otro</option>
      </select>
    </div>

    <!-- Fila 2: Historia cl√≠nica, Direcci√≥n, Tel√©fono -->
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <input type="text" placeholder="Historia cl√≠nica" id="historiaClinica" style="flex:1;">
      <input type="text" placeholder="Direcci√≥n / Localidad" id="direccionPaciente" style="flex:2;">
      <input type="text" placeholder="Tel√©fono / Contacto" id="telefonoPaciente" style="flex:1;">
    </div>
  </div>

  <!-- üîµ BUSCADOR CIE -->
  <div class="card">
    <h3>Buscar s√≠ntoma (CIE-11)</h3>
    <input type="text" id="buscadorSintomas" placeholder="Ej: tos, disnea...">
    <div id="listaResultados" class="lista-resultados"></div>
    <div id="resultadosCIE" class="sintomas-grid"></div>
  </div>

  <!-- üü¢ BUSCADOR SIGNOS -->
  <div class="card">
    <h3>Buscar signos cl√≠nicos</h3>
    <input type="text" id="buscadorSignos" placeholder="Ej: sibilancias, cr√©pitos...">
    <div id="listaSignos" class="lista-resultados"></div>
    <div id="resultadosSignos" class="sintomas-grid"></div>
  </div>

  <!-- ‚úÖ RESUMEN -->
  <div class="card">
    <h3>Resumen cl√≠nico</h3>
    <textarea id="resumenClinico" rows="10" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ccc;" placeholder="Aqu√≠ se generar√° el resumen cl√≠nico..."></textarea>
  </div>

  <button onclick="generarResumen()">Generar resumen</button>
</div>

<script>
// ================= UTIL =================
function normalizar(t) {
  return t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}

// ================= CIE =================
const inputCIE = document.getElementById("buscadorSintomas");
const listaCIE = document.getElementById("listaResultados");
const contCIE = document.getElementById("resultadosCIE");

inputCIE.addEventListener("input", async function() {
  const q = this.value.trim();
  listaCIE.innerHTML = "";
  if (!q) return;

  const res = await fetch(`/buscar?q=${encodeURIComponent(q)}`);
  const datos = await res.json();

  datos.forEach(item => {
    const d = document.createElement("div");
    d.className = "item-resultado";
    d.textContent = `${item.titulo} (${item.codigo})`;
    d.onclick = () => {
      agregarItem(contCIE, item.titulo + " (" + item.codigo + ")");
      listaCIE.innerHTML = "";
      inputCIE.value = "";
    };
    listaCIE.appendChild(d);
  });
});

// ================= SIGNOS =================
const signos = [
  "Sibilancias",
  "Cr√©pitantes",
  "Roncus",
  "Disminuci√≥n del murmullo vesicular",
  "Tiraje intercostal",
  "Uso de m√∫sculos accesorios",
  "Matidez a la percusi√≥n",
  "Hipersonoridad",
  "Cianosis",
  "Taquipnea",
  "Aleteo nasal"
];

const inputSignos = document.getElementById("buscadorSignos");
const listaSignos = document.getElementById("listaSignos");
const contSignos = document.getElementById("resultadosSignos");

inputSignos.addEventListener("input", function() {
  const q = normalizar(this.value);
  listaSignos.innerHTML = "";
  if (!q) return;

  signos
    .filter(s => normalizar(s).includes(q))
    .forEach(s => {
      const d = document.createElement("div");
      d.className = "item-resultado";
      d.textContent = s;
      d.onclick = () => {
        agregarItem(contSignos, s);
        listaSignos.innerHTML = "";
        inputSignos.value = "";
      };
      listaSignos.appendChild(d);
    });
});

// ================= AGREGAR =================
function agregarItem(contenedor, texto) {
  const label = document.createElement("label");
  label.className = "sintoma-card seleccionado";

  const check = document.createElement("input");
  check.type = "checkbox";
  check.checked = true;

  label.appendChild(check);
  label.append(" " + texto);

  label.onclick = () => {
    check.checked = !check.checked;
    label.classList.toggle("seleccionado", check.checked);
  };

  contenedor.appendChild(label);
}

// ================= RESUMEN =================
function generarResumen() {
  const nombre = document.getElementById("nombrePaciente").value || "NN";

  const fechaNac = document.getElementById("fechaNacimiento").value;
  let edad = "N/E";
  if (fechaNac) {
    const diff = new Date() - new Date(fechaNac);
    edad = Math.floor(diff / (1000 * 60 * 60 * 24 * 365)) + " a√±os";
  }

  const sexo = document.getElementById("sexoPaciente").value || "N/E";
  const historiaClinica = document.getElementById("historiaClinica").value || "N/E";
  const direccion = document.getElementById("direccionPaciente").value || "N/E";
  const telefono = document.getElementById("telefonoPaciente").value || "N/E";

  const sintomas = [...document.querySelectorAll("#resultadosCIE .seleccionado")]
    .map(e => e.textContent.trim());

  const signosSel = [...document.querySelectorAll("#resultadosSignos .seleccionado")]
    .map(e => e.textContent.trim());

  let texto = `Paciente ${nombre}, ${edad}, sexo ${sexo}.\nHistoria cl√≠nica: ${historiaClinica}\nDirecci√≥n: ${direccion}\nContacto: ${telefono}\n\n`;

  if (sintomas.length) {
    texto += "S√≠ntomas referidos:\n";
    sintomas.forEach(s => texto += `- ${s}\n`);
    texto += "\n";
  }

  if (signosSel.length) {
    texto += "Signos cl√≠nicos:\n";
    signosSel.forEach(s => texto += `- ${s}\n`);
    texto += "\n";
  }

  texto += "Evaluaci√≥n cl√≠nica orientada a patolog√≠a respiratoria. Correlacionar con examen f√≠sico completo y estudios complementarios seg√∫n criterio m√©dico.";

  document.getElementById("resumenClinico").value = texto;
}
</script>

</body>
</html>
